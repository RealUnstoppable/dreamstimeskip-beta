<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | DTS HUB</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0A0A0A;
            --primary-card-color: #141414;
            --secondary-card-color: #1f1f1f;
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #F5F5F7;
            --text-secondary: #A3A3A3;
            --accent-blue: #2563EB;
            --accent-red: #DC2626;
            --accent-green: #16A34A;
            --accent-yellow: #FBBF24;
            --font-main: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }
        .account-layout {
            display: flex;
            width: 100%;
            max-width: 1200px;
            gap: 30px;
        }
        .sidebar {
            width: 250px;
            flex-shrink: 0;
        }
        .btn-admin-back {
            display: block;
            background-color: var(--accent-yellow);
            color: var(--bg-color);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            text-decoration: none;
            margin-bottom: 20px;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .btn-admin-back:hover {
            opacity: 0.85;
        }
        .sidebar-header {
            padding: 20px;
            background-color: var(--primary-card-color);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .sidebar-header h2 {
            font-size: 1.2rem;
            margin: 0 0 5px 0;
            line-height: 1.2;
        }
        .sidebar-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
            word-wrap: break-word;
        }
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav a {
            display: block;
            padding: 15px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nav a:hover {
            background-color: var(--primary-card-color);
            color: var(--text-primary);
        }
        .sidebar-nav a.active {
            background-color: var(--accent-blue);
            color: var(--text-primary);
        }
        .sign-out-btn {
            width: 100%;
            margin-top: 20px;
            padding: 15px 20px;
            background-color: var(--primary-card-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .sign-out-btn:hover {
            background-color: var(--accent-red);
            color: var(--text-primary);
            border-color: var(--accent-red);
        }
        .main-content {
            flex-grow: 1;
        }
        .content-section {
            display: none;
            background-color: var(--primary-card-color);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .content-section.active {
            display: block;
        }
        .content-section h3 {
            font-size: 1.8rem;
            margin-top: 0;
            margin-bottom: 30px;
        }
        .card {
            background-color: var(--secondary-card-color);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .card h4 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .order, .subscription {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .order:last-child, .subscription:last-child {
            border-bottom: none;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            background-color: #2c2c2c;
            color: var(--text-primary);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-primary:hover { background-color: #1D4ED8; }
        .btn-danger { background-color: var(--accent-red); color: white; }
        .btn-danger:hover { background-color: #B91C1C; }
        #delete-account-card { border-color: var(--accent-red); }
        .notification { padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-top: 15px; display: none; }
        .notification.success { background-color: rgba(22, 163, 74, 0.2); color: var(--accent-green); }
        .notification.error { background-color: rgba(220, 38, 38, 0.2); color: var(--accent-red); }

        @media (max-width: 768px) {
            body { padding: 20px 10px; }
            .account-layout { flex-direction: column; }
            .sidebar { width: 100%; }
            .main-content { width: 100%; }
            .content-section { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="account-layout">
        <aside class="sidebar">
            <div id="admin-back-button-container"></div>
            <div class="sidebar-header">
                <h2 id="welcome-header">Loading...</h2>
                <p id="user-email-sidebar"></p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#dashboard" class="nav-link active">Dashboard</a></li>
                    <li><a href="#orders" class="nav-link">My Orders</a></li>
                    <li><a href="#subscriptions" class="nav-link">Subscriptions</a></li>
                    <li><a href="#settings" class="nav-link">Settings</a></li>
                    <li><a href="#support" class="nav-link">Support</a></li>
                </ul>
            </nav>
            <button class="sign-out-btn" id="sign-out">Sign Out</button>
        </aside>
        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <h3>Dashboard</h3>
                <div class="card">
                    <h4>Quick Overview</h4>
                    <p>Welcome to your personal hub. You can manage your orders, subscriptions, and account settings here.</p>
                </div>
                <div class="card">
                    <h4>Newsletter</h4>
                    <p>Stay in the loop with news, announcements, and exclusive beta access.</p>
                    <button class="btn btn-primary" id="newsletter-signup">Sign Up for Newsletter</button>
                    <div id="newsletter-notification" class="notification"></div>
                </div>
            </section>
            <section id="orders" class="content-section">
                <h3>My Orders</h3>
                <div class="card">
                     <p style="color: var(--text-secondary);">Order history is not yet available.</p>
                </div>
            </section>
            <section id="subscriptions" class="content-section">
                <h3>Subscriptions & Payment</h3>
                <div class="card">
                     <p style="color: var(--text-secondary);">Subscription management is not yet available.</p>
                </div>
            </section>
            <section id="settings" class="content-section">
                <h3>Settings</h3>
                <div class="card">
                    <h4>Update Profile</h4>
                    <form id="update-profile-form">
                        <div class="form-group">
                            <label for="update-username">Username</label>
                            <input type="text" id="update-username" required>
                        </div>
                        <div class="form-group">
                            <label for="update-email">Email</label>
                            <input type="email" id="update-email" disabled>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <div id="profile-notification" class="notification"></div>
                    </form>
                </div>
                <div class="card" id="delete-account-card">
                    <h4>Delete Account</h4>
                    <p>This action is permanent and cannot be undone. All your data will be removed.</p>
                    <button class="btn btn-danger" id="delete-account-btn">Delete My Account</button>
                </div>
            </section>
            <section id="support" class="content-section">
                <h3>Contact Support</h3>
                <div class="card">
                    <p>If you need help, please reach out. We're happy to assist!</p>
                    <a href="mailto:unstoppableplays2016@hotmail.com" class="btn btn-primary">Email Support</a>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBgrI9HwJPSc5b4pu2Egsv4DE7shNwptSw",
            authDomain: "dts-hub-website.firebaseapp.com",
            projectId: "dts-hub-website",
            storageBucket: "dts-hub-website.appspot.com",
            messagingSenderId: "48345990988",
            appId: "1:48345990988:web:e3662c9b508168546471e9",
            measurementId: "G-ZN3YJPHVGX"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    initializePage(user, userDoc.data());
                    setupEventListeners(user);
                } else {
                    signOut(auth);
                }
            } else {
                window.location.replace('sign in beta.html');
            }
        });

        function initializePage(user, userData) {
            const adminBackBtnContainer = document.getElementById('admin-back-button-container');
            if (userData.isAdmin) {
                const backButton = document.createElement('a');
                backButton.href = 'admin.html';
                backButton.className = 'btn-admin-back';
                backButton.textContent = 'â† Back to Admin';
                adminBackBtnContainer.appendChild(backButton);
            }

            const welcomeHeader = document.getElementById('welcome-header');
            if (sessionStorage.getItem('newUser')) {
                welcomeHeader.textContent = `Welcome, ${userData.username}!`;
                sessionStorage.removeItem('newUser');
            } else {
                welcomeHeader.textContent = `Welcome back, ${userData.username}!`;
            }

            document.getElementById('user-email-sidebar').textContent = user.email;
            document.getElementById('update-username').value = userData.username;
            document.getElementById('update-email').value = user.email;
        }

        function setupEventListeners(user) {
            document.getElementById('sign-out').addEventListener('click', () => {
                signOut(auth).then(() => window.location.replace('index.html'));
            });

            document.getElementById('update-profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newUsername = document.getElementById('update-username').value;
                const notificationEl = document.getElementById('profile-notification');
                const userDocRef = doc(db, "users", user.uid);
                
                try {
                    await updateDoc(userDocRef, { username: newUsername });
                    showNotification(notificationEl, 'Profile updated successfully!', 'success');
                    document.getElementById('welcome-header').textContent = `Welcome back, ${newUsername}!`;
                } catch (error) {
                    showNotification(notificationEl, `Error: ${error.message}`, 'error');
                }
            });

            document.getElementById('delete-account-btn').addEventListener('click', async () => {
                if (!confirm('DANGER: This will permanently delete your account. Are you sure?')) return;
                try {
                    await deleteDoc(doc(db, "users", user.uid));
                    await deleteUser(user);
                    alert('Account permanently deleted.');
                } catch (error) {
                     alert(`Error: ${error.message}. Please sign in again to perform this action.`);
                     signOut(auth);
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const targetId = e.currentTarget.getAttribute('href');
                    document.querySelector(targetId).classList.add('active');
                });
            });

            const showNotification = (element, message, type) => {
                element.textContent = message;
                element.className = 'notification';
                element.classList.add(type);
                element.style.display = 'block';
                setTimeout(() => { element.style.display = 'none'; }, 4000);
            };
        }
    </script>
</body>
</html>